---
title: "EVAR_machine_learning"
author: "Joshua Geiger and Mohammed Mehdi Shahid"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

Update! Dataset is done, and ready to go!

Hey Mehdi,

Thanks for getting this started. The rds dataset that i provided is a
pretty good clean start. The variable that we will be attempting to
predict is sac_regression_12m_cat. This variable states weather The
Shins aortic aneurysms sac regressed states stable or increased in size
at the one-year mark. I had to do a bit of reformatting of all of the
data in order to calculate this appropriately given the variability in
the CT scan dates and sizes. I am confident this variable is accurate at
the moment.

There are variables within the data set that are incomplete and perhaps
chart reviewing to finish collecting some of this data will be
important. Particularly the first couple of patients were recorded
before all of the VQI variables were established and so there is some
missing data there. Additionaly, the last 20 some patients I recently
extracted from the VQI and so variables we manually extracted from the
chart have not be collected yet. Baqir and I can help out with this.
Baqir has also submitted a request for the lab values for these last 20
some patients. In addition we will be obtaining dates of death for the
entire data set. I think doing an additional analysis using similar
methods on survival, either length of survival or survival at 5 years
will also be interesting.

## SETUP

### Install Packages

```{r setup}
# Installs pacman ("package manager") if needed
if (!require("pacman")) install.packages("pacman")

#Install relevant libraries using pacman (i.e. package manager)

# Use pacman to load add-on packages as desired
pacman::p_load(pacman, 
               # essentials
               tidyverse, rio, caret,
               
               #plots
               ggplot2, mice, missRanger,
               
               #machine learning
               ROSE,xgboost, ranger, naivebayes, e1071, nnet,
               
               # extras
               forcats, janitor, explore, caTools, Metrics, finalfit)
```

### Load data

```{r load-data}
#Sourcedir for Mehdi
EVARSourcedir <- "~/Desktop/EVAR/EVAR_cleaned_filtered_12_23_23.rds"

#Sourcedir for Josh
#EVARSourcedir <- "data/EVAR_cleaned_filtered_12_23_23.rds"

EVAR <- readRDS(EVARSourcedir)
```

### Correct Errors

```{r correct-errors}
#Correct errors in the EVAR dataframe
EVAR[ which(EVAR$primprocid == 798089), "height_cm"] <- 188.00
EVAR[ which(EVAR$primprocid == 798089), "bmi"] <- 32.7
```

Let's get a glimpse of the dataframe as it is now
Finalfit is a great package to do this
ff_glimpse() returns a list containing dataframes for continous and categorical vars
It gives mean, min, max, and na_counts and na_percent

```{r EVAR-ff-glimpse}
EVAR_glimpse <- ff_glimpse(EVAR)
```


## Cleaning Data

Remove cols and rows with too many missing values - remove records with
too many missing values (\>40%) - remove columns with too many missing
values (\>20%)

```{r}

# Remove records with too many missing values
EVAR_preprocess <- EVAR %>%
  select(which(colMeans(is.na(.)) <= 0.6)) #Remove observations with more than 60% missing data

# Remove columns with too many missing values
EVAR_preprocess <- EVAR %>%
  select(which(colMeans(is.na(.)) <= 0.4)) #Remove columns with more than 40% missing data

```

Remove unnecessary or uninformative columns

```{r}
EVAR_preprocess$zip_postal_code <- NULL
EVAR_preprocess$dysrhythmia <- NULL
EVAR_preprocess$primprocid <- NULL

#removing smoking quit date as I don't know how to work with this data type with ML for now....
#I created a years since quite smoking variable and removed the date. 
#EVAR_preprocess$quit_smoking_date <- NULL
```

### Data Types

Change column data types

When converting to factors make sure the ordering makes sense. For
example factor levels for smoking might look something like never, quit,
current. Changing the order to something like quit, current, never,
could very much mess with the analysis if these factors are considered
as ordinal variables, which they often are. can use fct_relevel to
change these

```{r}
# Convert all character columns to factors
EVAR_preprocess <- EVAR_preprocess %>%
  mutate_if(is.character, as.factor) %>%
  # conver to factor if unique values are less or equal to 5
  mutate_if(function(x) is.numeric(x) && n_distinct(x) <= 5, as.factor)

```

#### No and Yes variables

'No' and 'Yes' are mostly nominal, but for consistency, we can reorder
all factor variables with 'No' and 'Yes' to be No for level 1 and Yes
for level 2

```{r}
# Identify factor variables with 'No' and 'Yes' levels
no_yes_factors <- EVAR_preprocess %>%
  select(where(is.factor)) %>%
  keep(~ length(levels(.)) == 2 && all(c("No", "Yes") %in% levels(.)))

# Reorder the levels for 'No' as level 1 and 'Yes' as level 2
EVAR_preprocess <- EVAR_preprocess %>%
  mutate(across(all_of(names(no_yes_factors)), ~fct_relevel(., "No", "Yes")))

```

#### Releveling data

Determine which factors need to be releveled

```{r factor-variables}
# To make sure ordering of each factor variable makes sense, we must investigate each to determine which need to reordered with fct_relevel
# Extract information about factor variables
factorVars_info <- lapply(names(EVAR_preprocess), function(column_name) {
  column <- EVAR_preprocess[[column_name]]
  
  if (is.factor(column)) {
    levels_info <- levels(column)
    return(list(
      variable_name = column_name,
      num_levels = length(levels_info),
      levels = levels_info
    ))
  } else {
    return(NULL)  # Not a factor variable
  }
})

# Remove NULL elements (non-factor variables) from the list
factorVars_info <- factorVars_info[sapply(factorVars_info, function(x) !is.null(x))]

# Print the information
for (info in factorVars_info) {
  cat("Variable Name:", info$variable_name, "\n")
  cat("Number of Levels:", info$num_levels, "\n")
  cat("Levels:", paste(info$levels, collapse = "; "), "\n\n")
}
```

Based on the above output, we choose which variables to reorder and also
correct some errors within the dataset.

#### Convert to numeric

Correcting some errors - aortic_graft_length_1

Convert to num:
aortic_graft_length_1, right_iliac_graft_diameter_1, right_iliac_graft_length_1, left_iliac_graft_length_1

```{r correct-errors}
# aortic_graft_length_1 needs some error fixes and then convert to num
# Here we convert one of the errors from 90-30 to 90. Need to check if this is okay....

EVAR_preprocess <- EVAR_preprocess %>%
  mutate(
    # aortic_graft_length_1
    aortic_graft_length_1 = as.character(aortic_graft_length_1), 
    aortic_graft_length_1 = if_else(aortic_graft_length_1 == "90-30", 
                                    "90", aortic_graft_length_1),
    aortic_graft_length_1 = as.numeric(aortic_graft_length_1),
    
    
    # right_iliac_graft_diameter_1
    right_iliac_graft_diameter_1 = as.character(right_iliac_graft_diameter_1), 
    right_iliac_graft_diameter_1 = if_else(right_iliac_graft_diameter_1 == "16-14.5", 
                                           "16", right_iliac_graft_diameter_1),
    right_iliac_graft_diameter_1 = as.numeric(right_iliac_graft_diameter_1),
    
    
    #right_iliac_graft_length_1
    right_iliac_graft_length_1 = as.character(right_iliac_graft_length_1), 
    right_iliac_graft_length_1 = if_else(right_iliac_graft_length_1 == "Other", 
                                           NA, right_iliac_graft_length_1),
    right_iliac_graft_length_1 = as.numeric(right_iliac_graft_length_1),
    
    
    # left_iliac_graft_length_1
     left_iliac_graft_length_1 = as.character(left_iliac_graft_length_1), 
    left_iliac_graft_length_1 = if_else(left_iliac_graft_length_1 == "Other", 
                                           NA, left_iliac_graft_length_1),
    left_iliac_graft_length_1 = as.numeric(left_iliac_graft_length_1),
    )
```

Variables that need to be reordered: 

age_svs, cvd, prior_chf, copd, diabetes, smoking, 
pre_op_p2y12_antagonist, pre_op_beta_blocker, pre_op_chronic_anticoagulant, ejection_fraction, 
aorta_neck_angle, neck_aaa_angle,
anesthesia, prbc_in_or_or_preop, proximal_aortic_extensions, number_right,
ltf_statin, ltf_beta_blocker, ltf_ace_inhibitor_arb

```{r reorder-factors}
#age_svs
EVAR_preprocess$age_svs <- fct_relevel(EVAR_preprocess$age_svs,"0", "1" ,"2", "3")

#cvd
EVAR_preprocess$cvd <- fct_relevel(EVAR_preprocess$cvd,"None","Hx stroke, asymptomatic", "Hx stroke, minor deficit", "Hx stroke, major deficit")

#prior_chf
EVAR_preprocess$prior_chf <- fct_relevel(EVAR_preprocess$prior_chf,"None","Asymp, hx CHF", "Mild", "Moderate")

#copd
EVAR_preprocess$copd <- fct_relevel(EVAR_preprocess$copd,"No", "On home oxygen", "On meds", "Not treated")

#diabetes
EVAR_preprocess$diabetes <- fct_relevel(EVAR_preprocess$diabetes,"None","Diet","Non-insulin meds", "Insulin")

#smoking
EVAR_preprocess$smoking <- fct_relevel(EVAR_preprocess$smoking,"Never", "Prior", "Current")



#pre_op_p2y12_antagonist
EVAR_preprocess$pre_op_p2y12_antagonist <- fct_relevel(EVAR_preprocess$pre_op_p2y12_antagonist, "None", "No", "Clopidogrel","Ticagrelor", "Prasugrel" )

#pre_op_beta_blocker
EVAR_preprocess$pre_op_beta_blocker <- fct_relevel(EVAR_preprocess$pre_op_beta_blocker, "No", "No, for medical reason", "Pre-op 1-30 days", "Chronic > 30 days")

#pre_op_chronic_anticoagulant
EVAR_preprocess$pre_op_chronic_anticoagulant <- fct_relevel(EVAR_preprocess$pre_op_chronic_anticoagulant, "None", "No, for medical reason", "Other", "Rivaroxaban", "Warfarin", "Dabigatran")

#ejection_fraction
EVAR_preprocess$ejection_fraction <- fct_relevel(EVAR_preprocess$ejection_fraction,"Not done", "Unknown", "<30%", "30-50%", ">50%")


# Is aorta_neck_angle the same as neck_aaa_angle? 

#aorta_neck_angle
EVAR_preprocess$aorta_neck_angle <- fct_relevel(EVAR_preprocess$aorta_neck_angle, "< 45 Degrees", "45-60 Degrees", "61-75 Degrees", "76-90 Degrees", "> 90 Degrees")
#neck_aaa_angle
EVAR_preprocess$neck_aaa_angle <- fct_relevel(EVAR_preprocess$neck_aaa_angle,"< 45 Degrees", "45-60 Degrees", "61-75 Degrees", "76-90 Degrees", "> 90 Degrees")


#anesthesia
EVAR_preprocess$anesthesia <- fct_relevel(EVAR_preprocess$anesthesia,"Local", "Regional", "General")

EVAR_preprocess$prbc_in_or_or_preop <- fct_relevel(EVAR_preprocess$prbc_in_or_or_preop, "0", "1", "2", "3", "4")

#proximal_aortic_extensions
EVAR_preprocess$proximal_aortic_extensions <- fct_relevel(EVAR_preprocess$proximal_aortic_extensions, "None", "1", "2", "3")

#number_right
EVAR_preprocess$number_right <- fct_relevel(EVAR_preprocess$number_right,"None", "1", "2", "3")

# ltf_statin
EVAR_preprocess <- EVAR_preprocess %>%
  mutate(ltf_statin = as.character(ltf_statin)) %>%
  mutate(ltf_statin = factor(na_if(ltf_statin, ""), levels = c("Yes", "No, for medical reason", "No", "Non-compliant")))

# ltf_beta_blocker
EVAR_preprocess <- EVAR_preprocess %>%
  mutate(ltf_beta_blocker = as.character(ltf_beta_blocker)) %>%
  mutate(ltf_beta_blocker = factor(na_if(ltf_beta_blocker, ""), levels = c("Yes", "No, for medical reason", "No"))) %>%
  mutate(ltf_beta_blocker = fct_relevel(ltf_beta_blocker, "Yes", "No, for medical reason", "No")) 

# ltf_ace_inhibitor_arb
EVAR_preprocess <- EVAR_preprocess %>%
  mutate(ltf_ace_inhibitor_arb = as.character(ltf_ace_inhibitor_arb)) %>%
  mutate(ltf_ace_inhibitor_arb = factor(na_if(ltf_ace_inhibitor_arb, ""), levels = c("Yes", "No, for medical reason", "No"))) %>%
  mutate(ltf_ace_inhibitor_arb = fct_relevel(ltf_ace_inhibitor_arb, "Yes", "No, for medical reason", "No")) 
```

Now we generate a glimpse into EVAR_preprocess
```{r EVAR-preprocess-ff-glimpse}
EVAR_preprocess_glimpse <- ff_glimpse(EVAR_preprocess)
```


### Pre-processing report

Generate a report about the data before any pre-processing steps like scaling, and imputation
explore is a nice pkg with function report(). Generates plots and summary stats for all vars in database.

```{r pre-process-report}
EVAR_pre_report_filename <- "Report_EVAR_Preprocess.html"
EVAR_preprocess_report <- report(EVAR_preprocess, 
                                 output_file = EVAR_pre_report_filename,
                                 output_dir = getwd())
```

### Demographics Table

Generate a table1
Finalfit has a function called summary_factorlist() for this
It includes numeric and categorical variables, despite the name...
We want to include the missing data

Stratify against our outcome variable: sac_regression_12m_cat

Currently, there are some warnings: Chi-sq test may be incorrect

```{r table1-demographics}

EVAR_preprocess_predictorsdf <- EVAR_preprocess %>%
  select(-sac_regression_12m_cat)

demographics_table1 <- EVAR_preprocess %>%
  summary_factorlist(dependent = "sac_regression_12m_cat", # outcome variable
  explanatory = names(.)[names(.) != "sac_regression_12m_cat"] , #predictors
  na_include = TRUE,
  na_include_dependent = TRUE,
  total_col = TRUE,
  add_col_totals = TRUE,
  p = TRUE
  )

```

## Data Preprocessing

### One-hot encoding
We perform one-hot encoding for every categorical variable
Use dummyVars from caret

We also one-hot encode the outcome variable in order to transform the mtulti-class classification problem (3 levels: regression, stability and expansion) into two binary classification problems. Each binary outcome variable represents one of the classes versus the rest (often referred to as one-vs-rest or one-vs-all strategy

```{r one-hot-encode}
# fullRank TRUE ensures no linear dependencies induced between the columns
dummyEVAR <- dummyVars(" ~ .", data = EVAR_preprocess, fullRank=F)
EVAR_onehot <- data.frame(predict(dummyEVAR, newdata = EVAR_preprocess))
```

### Split Data

```{r split-data}

set.seed(42)

# split using caTools package
split_sample <- sample.split(EVAR_onehot$sac_regression_12m_cat.Regression, 
                             # 80 - 20 split
                             SplitRatio = 0.8)

# Subset train and test data frames
train_df <- subset(EVAR_onehot, split_sample == TRUE)
test_df <- subset(EVAR_onehot, split_sample == FALSE)
```

### Imputation
We assume data is missing at random (MAR). 

```{r train-ff-glimpse}
train_df_glimpse <- ff_glimpse(train_df)
```


The imputation strategy is to use MICE (Multivariate Imputation via Chained Equations).

#### Visualize missing data

```{r visualize-missing}
# Use VIM package
traindf_missing_plot <- aggr(train_df, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(train_df), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))

testdf_missing_plot <- aggr(test_df, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(test_df), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))


```

#### Missingness Pattern
Use md.pattern from mice pkg
We can also use missing_pattern() from finalfit

```{r missingness-pattern}
missingnesspatterndf <- md.pattern(train_df, plot = FALSE)

# num rows is the number of missing patterns
print(nrow(missingnesspatterndf))

```

Now we employ MICE

THIS STEP TAKES 20 MINS TO COMPLETE.

Can vary the number of iterations using Maxit
Can vary the number of imputed sets MICE makes using m
MICE imputes both categorical and numerical variables

```{r imputation}

# Impute missing values in the train dataset
traindf_imputed <- train_df %>%
  mice(method = 'cart', m = 1, maxit = 1) %>%
  densityplot() %>%
  complete()

# Impute missing values in the train dataset
testdf_imputed <- test_df %>%
  mice(method = 'cart', m = 1, maxit = 1) %>%
  densityplot() %>%
  complete()

# Now you have imputed versions of both train and test datasets
```

### Scaling

```{r}

# Apply scaling to numerical columns in train dataframe
train_scaled <- traindf_imputed %>%
  mutate_if(is.numeric, ~scales::rescale(., to = c(0, 1)))

# Apply scaling to numerical columns in test dataframe
test_scaled <- testdf_imputed %>%
  mutate_if(is.numeric, ~scales::rescale(., to = c(0, 1)))

```

We have finished preprocessing :)
```{r}
EVAR_post_report_filename <- "Report_EVAR_Postprocess.html"
EVAR_postprocess_report <- report(train_scaled, 
                                 output_file = EVAR_post_report_filename,
                                 output_dir = getwd())
```

\`\`\`
