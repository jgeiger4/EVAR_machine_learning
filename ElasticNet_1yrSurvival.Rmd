---
title: "ElasticNet_1yrSurvival"
author: "Mohammed Mehdi Shahid and Joshua Geiger" 
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Install Packages

```{r setup}
# Installs pacman ("package manager") if needed
if (!require("pacman")) install.packages("pacman")

#Install relevant libraries using pacman (i.e. package manager)

# Use pacman to load add-on packages as desired
pacman::p_load(pacman, 
               # essentials
               tidyverse, rio, caret, glmnet
               
               )
```


# Load Data
```{r load-data}
train <- readRDS("train_survival1yr.rds")
test <- readRDS("test_survival1yr.rds")
```

## Elastic Nets

### 1 Year Survival

#### Cross validation
```{r}
# Prepare your data
set.seed(1)
LassoX <- model.matrix(survival_1yr_censor.1 ~ ., data = train)
Lassoy <- train$survival_1yr_censor.1

# Perform 10-fold cross-validation to select lambda
lambdas_to_try <- 10^seq(-4, 4, length.out = 100)

# Setting alpha = 1 for lasso; alpha = 0 for ridge


cv8 <- cv.glmnet(LassoX, Lassoy, alpha = 0.80, lambda = lambdas_to_try,
                  standardize = TRUE, nfolds = 5, type.measure = "mse",
                  family = "binomial")
cv9 <- cv.glmnet(LassoX, Lassoy, alpha = 0.90, lambda = lambdas_to_try,
                  standardize = TRUE, nfolds = 5, type.measure = "mse",
                  family = "binomial")
cv95 <- cv.glmnet(LassoX, Lassoy, alpha = 0.95, lambda = lambdas_to_try,
                 standardize = TRUE, nfolds = 5, type.measure = "mse",
                 family = "binomial")
cv1 <- cv.glmnet(LassoX, Lassoy, alpha = 1, lambda = lambdas_to_try,
                 standardize = TRUE, nfolds = 5, type.measure = "mse",
                 family = "binomial")

# Plot cross-validation results
par(mfrow=c(2,2))
plot(cv8);plot(cv9);plot(cv95);plot(cv1)

# Compare the solution paths
par(mfrow=c(2,2))
plot(glmnet(LassoX, Lassoy, alpha = 0.80, family = "binomial"),xvar="lambda");
plot(glmnet(LassoX, Lassoy, alpha = 0.90, family = "binomial"),xvar="lambda");
plot(glmnet(LassoX, Lassoy, alpha = 0.95, family = "binomial"),xvar="lambda");
plot(glmnet(LassoX, Lassoy, alpha = 1, family = "binomial"),xvar="lambda")

coef(cv95)


### plot partial likelihood deviance
pld <- rbind(#cbind(Alpha = 0, min = cv0$lambda.min, se1 = cv0$lambda.1se),
      #cbind(Alpha = 0.2, min = cv2$lambda.min, se1 = cv2$lambda.1se),
      #cbind(Alpha = 0.4, min = cv4$lambda.min, se1 = cv4$lambda.1se),
      #cbind(Alpha = 0.6, min = cv6$lambda.min, se1 = cv6$lambda.1se),
      cbind(Alpha = 0.80, min = cv8$lambda.min, se1 = cv8$lambda.1se),
      cbind(Alpha = 0.90, min = cv9$lambda.min, se1 = cv9$lambda.1se),
      cbind(Alpha = 0.95, min = cv95$lambda.min, se1 = cv95$lambda.1se),
      cbind(Alpha = 1, min = cv1$lambda.min, se1 = cv1$lambda.1se))

pld

pld <- as.data.frame(pld) %>%
  pivot_longer(cols = c(min, se1),
                            names_to = "Measure", 
                            values_to = "Partial Likelihood Deviance")
      
ggplot(pld, aes(x = Alpha, y = `Partial Likelihood Deviance`,
                color = Measure)) +
  geom_line() +
  theme_classic()
```

```{r}
set.seed(1)
# Fit the logistic regression model with Lasso regularization
lasso_model <- glmnet(LassoX, Lassoy,
                         family = "binomial",
                      alpha = 0.90,
                      nlambda = 100)

# Choose the optimal lambda (regularization parameter) using cross-validation
best_lambda <- lasso_model$lambda.min

# Refit the model using the selected lambda
lasso_model_final <- lasso_model <- glmnet(LassoX, Lassoy,
                         family = "binomial",
                      alpha = 0.90,
                      lambda = best_lambda)

# Extract coefficients from the model
coefficients <- coef(lasso_model_final)

# Extract coefficients from the model
coefficients <- as.data.frame(as.matrix(coef(lasso_model_final)))

# Convert to data frame with proper column names
coefficients_df <- rownames_to_column(coefficients, var = "Variable")

coefficients_df <- coefficients_df %>%
  filter(s0 != 0)

ggplot(coefficients_df, aes(x = Variable, y = s0)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() +
  labs(x = "Variables", y = "Coefficients", title = "Lasso Regression Coefficients") +
  theme_minimal()
```


```{r}
result <- predict(lasso_model_final,
                  newdata = test %>% select(-survival_1yr_censor.1), # use the test set
                  type = "coefficients")

as.data.frame(as.matrix(result))

```



